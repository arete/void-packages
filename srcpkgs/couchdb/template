# Template file for 'couchdb'
pkgname=couchdb
version=2.3.0
revision=1
wrksrc="apache-couchdb-$version"
build_style=configure
conf_files="/etc/couchdb/local.ini"
hostmakedepends="erlang pkg-config"
makedepends="libressl-devel icu-devel js-devel libcurl-devel"
short_desc="A document-oriented database"
maintainer="Gerardo Di Iorio <arete74@gmail.com>"
license="Apache-2.0"
homepage="http://couchdb.apache.org/"
distfiles="https://dist.apache.org/repos/dist/release/couchdb/source/${version}/apache-couchdb-${version}.tar.gz"
checksum=0b3868d042b158d9fd2f504804abd93cd22681c033952f832ce846672c31f352
make_build_args+='release'

system_accounts="couchdb"
couchdb_homedir="/var/lib/couchdb"
make_dirs="
	/var/lib/couchdb 0700 couchdb couchdb
	/var/log/couchdb 0750 couchdb couchdb
	/etc/couchdb     0700 couchdb couchdb"
pre_build() {
if [ "$CROSS_BUILD" ]; then
	sed -i '/linux.*\(usr\|opt\)/s/-I/-I${XBPS_CROSS_BASE}/' src/couch/rebar.config.script
fi
}
do_install() {
	# CouchDB 2.0.0 does not support "make install" yet
	vmkdir /usr/lib/
	vmkdir /etc/couchdb/
	vmkdir /var/lib/couchdb/
	vinstall rel/couchdb/etc/local.ini  644 etc/couchdb/
	#Copy datadirs config file
	# remove local erts
	rm -rf rel/couchdb/erts-8.1
	vcopy rel/couchdb usr/lib/couchdb
	#Copy datadirs config file
	vcopy  ${FILESDIR}/datadirs.ini  etc/couchdb/datadirs.ini
	# use system erts
	ln -s /usr/lib/erlang/erts-8.1 "${DESTDIR}"/usr/lib/couchdb/erts-8.1
}

post_install() {
	vlicense rel/couchdb/LICENSE
	vman rel/couchdb/share/docs/couchdb.1
	vsv couchdb
}
