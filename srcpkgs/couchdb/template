# Template file for 'couchdb'
pkgname=couchdb
version=3.0.1
revision=1
wrksrc="apache-couchdb-${version}"
build_style=configure
make_build_args="V=1"
make_build_target="release"
configure_args="--user couchdb --with-curl --spidermonkey-version 60"
conf_files="/etc/couchdb/*.ini"
hostmakedepends="erlang help2man"
makedepends="libressl-devel icu-devel mozjs60-devel libcurl-devel"
depends="erlang"
short_desc="Document-oriented database"
maintainer="Gerardo Di Iorio <arete74@gmail.com>"
license="Apache-2.0"
homepage="http://couchdb.apache.org/"
distfiles="https://downloads.apache.org/couchdb/source/${version}/apache-couchdb-${version}.tar.gz"
checksum=08d61d5c779957d074d5097f28a2dfc9eb518af3c479d5318135ff31212cc522

system_accounts="couchdb"
couchdb_homedir="/var/lib/couchdb"
couchdb_shell="/bin/sh"
couchdb_descr="CouchDB Administrator"
make_dirs="
 /var/lib/couchdb 0700 couchdb couchdb
 /var/log/couchdb 0750 couchdb couchdb"

if [ "$CROSS_BUILD" ]; then
	hostmakedepends+=" mozjs60-devel"
	makedepends+=" erlang"
	ERL_CFLAGS="-I${XBPS_CROSS_BASE}/usr/include/js -I${XBPS_CROSS_BASE}/usr/lib/erlang/usr/include"
fi

pre_configure() {
	if [ "$CROSS_BUILD" ]; then
		vsed -i src/rebar/src/rebar_port_compiler.erl \
			-e "s;, erl_interface_dir(lib);, \"${XBPS_CROSS_BASE}/\"&;"
		make -C src/rebar
	fi
	configure_args+= ERL_CFLAGS="${ERL_CFLAGS}"
}

do_install() {
	local dir
	if [ "$CROSS_BUILD" ]; then
		# Copy target erlang libraries into release
		for dir in $(ls rel/couchdb); do
			if [ -d "${XBPS_CROSS_BASE}/usr/lib/erlang/${dir}" ]; then
				echo "Copying target erlang ${dir} ..."
				cp -pRv ${XBPS_CROSS_BASE}/usr/lib/erlang/${dir}/* \
					rel/couchdb/${dir}/
			fi
		done
		for dir in $(ls rel/couchdb/lib); do
			if [ -d "${XBPS_CROSS_BASE}/usr/lib/erlang/lib/${dir}" ]; then
				echo "Copying target erlang ${dir} ..."
				cp -pR ${XBPS_CROSS_BASE}/usr/lib/erlang/lib/${dir}/* \
					rel/couchdb/lib/${dir}/
			fi
		done
	fi

	# Change permissions according to the installation guide at
	# https://docs.couchdb.org/en/stable/install/unix.html
	find rel -type d -exec chmod 0770 "{}" \;
	find rel/couchdb/etc  -type f -exec chmod 0640 "{}" \;


	# Write a log-to-file configuration to default.d/10-logfile.ini
	cat >> rel/couchdb/etc/default.d/10-logfile.ini <<- EOF
	[log]
	writer = file
	file = /var/log/couchdb/couch.log
	level = info
	EOF

	# Write a single_node = true configuration to local.d/10-single_node.ini
	cat >> rel/couchdb/etc/local.d/10-single_node.ini <<- EOF
	[couchdb]
	single_node = true
	EOF

	# Write database folder config to default.d/20-datafolder.init <<- EOF
	cat  >> rel/couchdb/etc/default.d/20-data_folder.ini <<- EOF
	[couchdb]
	view_index_dir = /var/lib/couchdb/data
	database_dir = /var/lib/couchdb/data
	EOF

	# Copy the release to usr/lib/couchdb
	vmkdir usr/lib
	vcopy rel/couchdb usr/lib

	# Manual page
	vman rel/couchdb/share/docs/couchdb.1

	# Symbolic links for the configation (ini) files
	vmkdir etc/couchdb
	ln -srv ${DESTDIR}/usr/lib/couchdb/etc/default.ini ${DESTDIR}/etc/couchdb
	ln -srv ${DESTDIR}/usr/lib/couchdb/etc/default.d ${DESTDIR}/etc/couchdb
	ln -srv ${DESTDIR}/usr/lib/couchdb/etc/local.ini ${DESTDIR}/etc/couchdb
	ln -srv ${DESTDIR}/usr/lib/couchdb/etc/local.d ${DESTDIR}/etc/couchdb
	ln -srv ${DESTDIR}/usr/lib/couchdb/etc/vm.args ${DESTDIR}/etc/couchdb

	# Symbolic link for the binary
	vmkdir usr/bin
	ln -srv ${DESTDIR}/usr/lib/couchdb/bin/couchdb ${DESTDIR}/usr/bin/couchdb

	vsv couchdb
}
